# .github/workflows/deploy.yml

name: Deploy to Environments

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - staging
          - production
      version:
        description: 'Version to deploy (leave empty for latest)'
        required: false
        type: string

env:
  IMAGE_NAME: devops-todo-app

jobs:
  # Job 1: Validate
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.validate.outputs.environment }}
      version: ${{ steps.validate.outputs.version }}
      image_tag: ${{ steps.validate.outputs.image_tag }}
    
    steps:
      - name: Validate inputs
        id: validate
        run: |
          ENV="${{ inputs.environment }}"
          VERSION="${{ inputs.version }}"

          # If no version provided, use commit SHA
          if [ -z "$VERSION" ]; then
            VERSION=$(echo "${{ github.sha }}" | cut -c1-7)
          fi

          IMAGE_TAG="${ENV}-${VERSION}"

          # âœ… Set outputs correctly
          echo "environment=${ENV}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

          # Debug: print values to confirm they're set
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Environment : ${ENV}"
          echo "  Version     : ${VERSION}"
          echo "  Image Tag   : ${IMAGE_TAG}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # Job 2: Test
  test:
    name: Run Tests Before Deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install and test
        run: |
          npm ci
          npm test

  # Job 3: Build
  build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: [validate, test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      # Debug: print what we're about to push
      - name: Print image tags
        run: |
          echo "Pushing these tags:"
          echo "  1. ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ needs.validate.outputs.image_tag }}"
          echo "  2. ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ needs.validate.outputs.environment }}"
      
      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ needs.validate.outputs.image_tag }}
            ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ needs.validate.outputs.environment }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Job 4: Verify
     # Replace just the verify job in deploy.yml

  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [validate, build]
    
    steps:
        - name: Login to Docker Hub
          uses: docker/login-action@v2
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}
        
        - name: Pull image
          run: |
            IMAGE="${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ needs.validate.outputs.environment }}"
            echo "Pulling: ${IMAGE}"
            docker pull "${IMAGE}"
        
        - name: Run container
          run: |
            IMAGE="${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ needs.validate.outputs.environment }}"
            ENV="${{ needs.validate.outputs.environment }}"
            
            echo "Starting container..."
            docker run -d \
            --name verify-app \
            -p 3000:3000 \
            -e "NODE_ENV=${ENV}" \
            "${IMAGE}"
            
            echo "Container started!"
        
        # âœ… FIX: Check if container is actually running
        - name: Check container status
          run: |
            echo "Waiting for container to be ready..."
            sleep 3
            
            echo "Container status:"
            docker ps -a | grep verify-app
            
            echo ""
            echo "Container logs:"
            docker logs verify-app
            
            # Check if container is still running
            if ! docker ps | grep -q verify-app; then
            echo "âŒ Container is not running!"
            echo "Full logs:"
            docker logs verify-app
            exit 1
            fi
            
            echo "âœ… Container is running!"
        
        - name: Wait for app to start
          run: |
            echo "Waiting for app to start..."
            for i in {1..30}; do
            if curl -f http://localhost:3000/health 2>/dev/null; then
                echo "âœ… App is ready!"
                exit 0
            fi
            echo "Attempt $i/30: App not ready yet..."
            sleep 2
            done
            
            echo "âŒ App did not start in time"
            echo "Container logs:"
            docker logs verify-app
            exit 1
        
        - name: Health check
          run: |
            echo "Running health check..."
            curl -f http://localhost:3000/health
            echo ""
            echo "âœ… Health check passed!"
        
        - name: Smoke test
          run: |
            echo "Testing API..."
            curl -f http://localhost:3000/api/todos
            echo ""
            echo "âœ… Smoke tests passed!"
        
        - name: Clean up
          if: always()
          run: |
            docker stop verify-app || true
            docker rm verify-app || true
  # Job 5: Summary
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [validate, verify]
    
    steps:
      - name: Create summary
        run: |
          echo "## ðŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ needs.validate.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ needs.validate.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image | ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Check | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull and Run:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ needs.validate.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "docker run -e NODE_ENV=${{ needs.validate.outputs.environment }} -p 3000:3000 ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ needs.validate.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  deploy-railway:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    needs: [validate, build]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Deploy to Railway
        run: |
          railway up --service ${{ needs.validate.outputs.environment }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}